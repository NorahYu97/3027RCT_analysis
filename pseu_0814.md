---
title: "pseu_0814"
author: "Norah Yu"
date: '2023-08-14'
output: html_document
---

# Fig.2 Immunogenicity of RQ3027, RQ3025 and RQ3013
## Overall immunogenicity analysis
``` {r Overall immunogenicity analysis}
library(patchwork)
library(Rmisc)
library(rstatix)
library(ggbeeswarm)
library(scales)
setwd("/DATA2/xuanjingyu/RQ3027 IIT/GMT")
## Using B1B4  data
B1 <- fread("/DATA2/xuanjingyu/RQ3027 IIT/GMT/B1_0814.csv") %>% as.data.frame()
B4 <- fread("/DATA2/xuanjingyu/RQ3027 IIT/GMT/B4_0814.csv") %>% as.data.frame()
B1B4 <- rbind(B1,B4)
## Del infected row
# mer_B1B4_sum <- inner_join(B1B4, sum_data, by = "ID")
# B1B4_ninfec <- mer_B1B4_sum %>% filter(PostV1BTI != "yes" & 
#                                          PostV2BTI != "yes" & 
#                                          PostV3BTI != "yes")
B1B4_ninfec <- B1B4[!B1B4$ID %in% c("FB147","FB211","FB299","FB277", "FB361",
                             "FB117" ,"FB320" , "FB342", "FB336", "FB335" ,
                             "FB374",
                             "FB198" ,"FB206","FB189", "FB295",
                             "FB169","FB349","FB369"),]
## Del non-relevant column
B1B4_clean <- B1B4_ninfec[,-c(6:23)]
## Rename
B1B4_clean$Patch <- ifelse(B1B4_clean$Patch == "B1","Day0",
                               ifelse(B1B4_clean$Patch == "B4", "Day14",
                                      B1B4_clean$Patch))
colnames(B1B4_clean)[colnames(B1B4_clean) == "SARS-CoV-2"] <- "VOC"
## Del V4 drop-out row
ov_B1B4 <- B1B4_clean %>% filter(ID != "FB030" &
                                          ID != "FB188"&
                                          ID != "FB291")

## Select XBB.1.16, BQ.1.1, BF.7,WT,BA.45 data
ov_B1B4_0814 <- subset(ov_B1B4, VOC %in% c("XBB.1.16",
                                           "XBB.1.9.1",
                                           "XBB.1.5",
                                           "BQ.1.1",
                                           "BF.7",
                                           "BA.4/5",
                                           "Beta",
                                           "Alpha",
                                           "Prototype"))
## GMT
ov_B1B4_0814_log <- ov_B1B4_0814
ov_B1B4_0814_log$Levels <- log(ov_B1B4_0814_log$Levels)
GMT_ov_B1B4<-summarySE(ov_B1B4_0814_log, measurevar="Levels",
                    groupvars=c("Patch","Group","VOC"),
                    na.rm = TRUE)
GMT_ov_B1B4$"GMT95%CI.n" <- paste0(round(exp(GMT_ov_B1B4$Levels),2)," (",paste(round(exp(GMT_ov_B1B4$Levels-GMT_ov_B1B4$ci),2),"-",paste(round(exp(GMT_ov_B1B4$Levels+GMT_ov_B1B4$ci),2)),";","n=",GMT_ov_B1B4$N),")") 
GMT_ov_B1B4$GMT <- exp(GMT_ov_B1B4$Levels)
GMT_ov_B1B4$lowerCI <- round(exp(GMT_ov_B1B4$Levels-GMT_ov_B1B4$ci),2)
GMT_ov_B1B4$upperCI <- round(exp(GMT_ov_B1B4$Levels+GMT_ov_B1B4$ci),2)

## GMFR
ov_B1B4_0814_di <- ov_B1B4_0814 %>% 
  pivot_wider(names_from = "Patch",
              values_from = "Levels") %>% 
  group_by(VOC,Group) %>% 
  mutate(GMFR = Day14/Day0) %>% 
  ungroup()
ov_B1B4_0814_di$GMFR <- log(ov_B1B4_0814_di$GMFR)
GMFR_ov_B1B4<-summarySE(ov_B1B4_0814_di, measurevar="GMFR",
                    groupvars=c("Group","VOC"),
                    na.rm = TRUE)
GMFR_ov_B1B4$"GMFR95%CI.n" <- paste0(round(exp(GMFR_ov_B1B4$GMFR),1),
                                    " (",
                                    paste(round(exp(GMFR_ov_B1B4$GMFR-GMFR_ov_B1B4$ci),1),
                                          "-",
                                          paste(round(exp(GMFR_ov_B1B4$GMFR+GMFR_ov_B1B4$ci),1)),
                                          ";",
                                          "n=",
                                          GMFR_ov_B1B4$N),
                                    ")") 
## GMR ov_B4_Prototype
ov_B4_Prototype <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="Prototype" )
ov_B4_Prototype$log <- log(ov_B4_Prototype$Levels)
ov_B4_Prototype_wider <- reshape::cast(ov_B4_Prototype[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_Prototype <- lm(Day14~Day0+Group,data=ov_B4_Prototype_wider)
summary(fit_ov_B4_Prototype)
round(exp(confint(fit_ov_B4_Prototype,'GroupRQ3025',level = 0.95)),2)
round(exp(confint(fit_ov_B4_Prototype,'GroupRQ3027',level = 0.95)),2)

## GMR ov_B4_BA.4/5
ov_B4_BA.45 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="BA.4/5" )
ov_B4_BA.45$log <- log(ov_B4_BA.45$Levels)
ov_B4_BA.45_wider <- reshape::cast(ov_B4_BA.45[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_BA.45 <- lm(Day14~Day0+Group,data=ov_B4_BA.45_wider)
summary(fit_ov_B4_BA.45)
round(exp(confint(fit_ov_B4_BA.45,'GroupRQ3025',level = 0.95)),2)
round(exp(confint(fit_ov_B4_BA.45,'GroupRQ3027',level = 0.95)),2)

## GMR ov_B4_BF.7
ov_B4_BF.7 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="BF.7" )
ov_B4_BF.7$log <- log(ov_B4_BF.7$Levels)
ov_B4_BF.7_wider <- reshape::cast(ov_B4_BF.7[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_BF.7 <- lm(Day14~Day0+Group,data=ov_B4_BF.7_wider)
summary(fit_ov_B4_BF.7)
round(exp(confint(fit_ov_B4_BF.7,'GroupRQ3025',level = 0.95)),1)
round(exp(confint(fit_ov_B4_BF.7,'GroupRQ3027',level = 0.95)),1)
## GMR ov_B4_BQ.1.1
ov_B4_BQ.1.1 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="BQ.1.1" )
ov_B4_BQ.1.1$log <- log(ov_B4_BQ.1.1$Levels)
ov_B4_BQ.1.1_wider <- reshape::cast(ov_B4_BQ.1.1[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_BQ.1.1 <- lm(Day14~Day0+Group,data=ov_B4_BQ.1.1_wider)
summary(fit_ov_B4_BQ.1.1)
round(exp(confint(fit_ov_B4_BQ.1.1,'GroupRQ3025',level = 0.95)),1)
round(exp(confint(fit_ov_B4_BQ.1.1,'GroupRQ3027',level = 0.95)),1)

## GMR ov_B4_XBB.1.5
ov_B4_XBB.1.5 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="XBB.1.5" )
ov_B4_XBB.1.5$log <- log(ov_B4_XBB.1.5$Levels)
ov_B4_XBB.1.5_wider <- reshape::cast(ov_B4_XBB.1.5[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_XBB.1.5 <- lm(Day14~Day0+Group,data=ov_B4_XBB.1.5_wider)
summary(fit_ov_B4_XBB.1.5)
round(exp(confint(fit_ov_B4_XBB.1.5,'GroupRQ3025',level = 0.95)),1)
round(exp(confint(fit_ov_B4_XBB.1.5,'GroupRQ3027',level = 0.95)),1)


## GMR ov_B4_XBB.1.16
ov_B4_XBB.1.16 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="XBB.1.16" )
ov_B4_XBB.1.16$log <- log(ov_B4_XBB.1.16$Levels)
ov_B4_XBB.1.16_wider <- reshape::cast(ov_B4_XBB.1.16[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_XBB.1.16 <- lm(Day14~Day0+Group,data=ov_B4_XBB.1.16_wider)
summary(fit_ov_B4_XBB.1.16)
round(exp(confint(fit_ov_B4_XBB.1.16,'GroupRQ3025',level = 0.95)),1)
round(exp(confint(fit_ov_B4_XBB.1.16,'GroupRQ3027',level = 0.95)),1)


## GMR ov_B4_XBB.1.9.1
ov_B4_XBB.1.9.1 <- subset(ov_B1B4_0814,ov_B1B4_0814$VOC=="XBB.1.9.1" )
ov_B4_XBB.1.9.1$log <- log(ov_B4_XBB.1.9.1$Levels)
ov_B4_XBB.1.9.1_wider <- reshape::cast(ov_B4_XBB.1.9.1[,-c(4,5)],
                                     ID+Group~Patch)
fit_ov_B4_XBB.1.9.1 <- lm(Day14~Day0+Group,data=ov_B4_XBB.1.9.1_wider)
summary(fit_ov_B4_XBB.1.9.1)
round(exp(confint(fit_ov_B4_XBB.1.9.1,'GroupRQ3025',level = 0.95)),1)
round(exp(confint(fit_ov_B4_XBB.1.9.1,'GroupRQ3027',level = 0.95)),1)

## GMR 2725_B4_XBB.1.16
s_B4_XBB.1.16 <- subset(ov_B4_XBB.1.16,Group %in% c("RQ3027",
                                                    "RQ3025"))
s_B4_XBB.1.16$log <- log(s_B4_XBB.1.16$Levels)
s_B4_XBB.1.16_wider <- reshape::cast(s_B4_XBB.1.16[,-c(4,5)],
                                     ID+Group~Patch)
fit_s_B4_XBB.1.16 <- lm(Day14~Day0+Group,data=s_B4_XBB.1.16_wider)
summary(fit_s_B4_XBB.1.16)
round(exp(confint(fit_s_B4_XBB.1.16,'GroupRQ3027',level = 0.95)),1)

```


``` {r Overall B1B4 Immunogenicity plot}
# Levels
GMT_ov_B1B4$Patch <- factor(GMT_ov_B1B4$Patch,levels = c("Day0","Day14"))
GMT_ov_B1B4$Group <- factor(GMT_ov_B1B4$Group,levels = c("RQ3013",
                                                   "RQ3025",
                                                   "RQ3027"))
GMT_ov_B1B4$VOC <- factor(GMT_ov_B1B4$VOC,levels = c("Prototype",
                                                     "Alpha",
                                                     "Beta",
                                                     "BA.4/5",
                                                     "BF.7",
                                                     "BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
ov_B1B4_0814$VOC <- factor(ov_B1B4_0814$VOC, levels = c("Prototype",
                                                     "Alpha",
                                                     "Beta",
                                                     "BA.4/5",
                                                     "BF.7",
                                                     "BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
# ggplot
p_co_B1B4 <- ggplot(GMT_ov_B1B4, aes(x=Patch,y=GMT,color=VOC)) +
  geom_bar(stat="identity",position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") +
  facet_grid(~Group) 
p_co_B1B4 <- p_co_B1B4 + geom_errorbar(aes(ymin=lowerCI,
                                               ymax=upperCI),
                                           width=.2,
                                           size=0.5,
                                           position = position_dodge(0.9))
p_co_B1B4 <- p_co_B1B4 + geom_beeswarm(data = ov_B1B4_0814,
                                           dodge.width = 0.9,
                                           aes(y = Levels,
                                               x= Patch,
                                               color=VOC),
                                           cex = 0.5,
                                           size = 1,
                                           alpha=.4,
                                           shape=16,
                                           show.legend = FALSE,)
p_co_B1B4 <- p_co_B1B4 + theme_classic() +
  scale_color_manual(values = c("Prototype" = "#09357A",
                                "Alpha" = "#7725C6",
                                "Beta" = "#5A39E8",
                                "BA.4/5" = "#02915A",
                                "BF.7" = "#5181FF",
                                "BQ.1.1" = "#74D3D0",
                                "XBB.1.5" = "#F1EC5B",
                                "XBB.1.16" = "#FF903E",
                                "XBB.1.9.1" = "#FF322C")) +
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0)))
p_co_B1B4 <- p_co_B1B4 + scale_y_continuous(
                     trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")

```

``` {r 5 variants B1B4 Immunogenicity plot}
# Subset variants
GMT_ov5_B1B4 <- subset(GMT_ov_B1B4,VOC %in% c("Prototype",
                                                     "Alpha",
                                                     "Beta",
                                                     "BA.4/5",
                                                     "BF.7"))
ov5_B1B4_0814 <- subset(ov_B1B4_0814,VOC %in% c("Prototype",
                                                     "Alpha",
                                                     "Beta",
                                                     "BA.4/5",
                                                     "BF.7"))
# Levels
GMT_ov5_B1B4$Patch <- factor(GMT_ov5_B1B4$Patch,levels = c("Day0","Day14"))
GMT_ov5_B1B4$Group <- factor(GMT_ov5_B1B4$Group,levels = c("RQ3013",
                                                   "RQ3025",
                                                   "RQ3027"))
GMT_ov5_B1B4$VOC <- factor(GMT_ov5_B1B4$VOC,levels = c("Prototype",
                                                     "Alpha",
                                                     "Beta",
                                                     "BA.4/5",
                                                     "BF.7"))
ov5_B1B4_0814$VOC <- factor(ov5_B1B4_0814$VOC,levels = c("Prototype",
                                       "Alpha",
                                       "Beta",
                                       "BA.4/5",
                                       "BF.7"))
# ggplot
p_co5_B1B4 <- ggplot(GMT_ov5_B1B4, aes(x=Patch,y=GMT,color=VOC)) +
  geom_bar(stat="identity",position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") +
  facet_grid(~Group) 
p_co5_B1B4 <- p_co5_B1B4 + geom_errorbar(aes(ymin=lowerCI,
                                               ymax=upperCI),
                                           width=.2,
                                           size=0.5,
                                           position = position_dodge(0.9))
p_co5_B1B4 <- p_co5_B1B4 + geom_beeswarm(data = ov5_B1B4_0814,
                                           dodge.width = 0.9,
                                           aes(y = Levels,
                                               x= Patch,
                                               color=VOC),
                                           cex = 0.7,
                                           size = 1.2,
                                           alpha = .4,
                                         shape = 16,
                                           show.legend = FALSE)
p_co5_B1B4 <- p_co5_B1B4 + theme_classic() +
  scale_color_manual(values = c("Prototype" = "#09357A",
                                "Alpha" = "#7725C6",
                                "Beta" = "#5A39E8",
                                "BA.4/5" = "#02915A",
                                "BF.7" = "#5181FF")) +
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0)))
p_co5_B1B4 <- p_co5_B1B4 + scale_y_continuous(
                     trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
p_co5_B1B4

```

``` {r 4 variants B1B4 Immunogenicity plot}
# Subset variants
GMT_ov4_B1B4 <- subset(GMT_ov_B1B4,VOC %in% c("BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
ov4_B1B4_0814 <- subset(ov_B1B4_0814,VOC %in% c("BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
# Levels
GMT_ov4_B1B4$Patch <- factor(GMT_ov4_B1B4$Patch,levels = c("Day0","Day14"))
GMT_ov4_B1B4$Group <- factor(GMT_ov4_B1B4$Group,levels = c("RQ3013",
                                                   "RQ3025",
                                                   "RQ3027"))
GMT_ov4_B1B4$VOC <- factor(GMT_ov4_B1B4$VOC,levels = c("BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
ov4_B1B4_0814$VOC <- factor(ov4_B1B4_0814$VOC,levels = c("BQ.1.1",
                                                     "XBB.1.5",
                                                     "XBB.1.16",
                                                     "XBB.1.9.1"))
# ggplot
p_co4_B1B4 <- ggplot(GMT_ov4_B1B4, aes(x=Patch,y=GMT,color=VOC)) +
  geom_bar(stat="identity",position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") +
  facet_grid(~Group) 
p_co4_B1B4 <- p_co4_B1B4 + geom_errorbar(aes(ymin=lowerCI,
                                               ymax=upperCI),
                                           width=.2,
                                           size=0.5,
                                           position = position_dodge(0.9))
p_co4_B1B4 <- p_co4_B1B4 + geom_beeswarm(data = ov4_B1B4_0814,
                                           dodge.width = 0.9,
                                           aes(y = Levels,
                                               x= Patch,
                                               color=VOC),
                                           cex = 0.7,
                                           size = 1.2,
                                           alpha = .4,
                                         shape = 16,
                                           show.legend = FALSE)
p_co4_B1B4 <- p_co4_B1B4 + theme_classic() +
  scale_color_manual(values = c("BQ.1.1" = "#66A885",
                                "XBB.1.5" = "#B5B144",
                                "XBB.1.16" = "#FF903E",
                                "XBB.1.9.1" = "#FF322C")) +
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0)))
p_co4_B1B4 <- p_co4_B1B4 + scale_y_continuous(
                     trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
p_co4_B1B4

```