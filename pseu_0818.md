---
title: "pseu_0818"
author: "Norah Yu"
date: '2023-08-18'
output: html_document
---

# Fig.2 Immunogenicity of RQ3027, RQ3025 and RQ3013
## Each variant analysis
``` {r Each variant immunogenicity analysis}
library(patchwork)
library(Rmisc)
library(rstatix)
library(ggbeeswarm)
library(scales)

## Using B1B4  data
B1 <- fread("/DATA2/xuanjingyu/RQ3027 IIT/GMT/B1_0816.csv") %>% as.data.frame()
B4 <- fread("/DATA2/xuanjingyu/RQ3027 IIT/GMT/B4_0814.csv") %>% as.data.frame()
B1B4 <- rbind(B1,B4)
## Del infected row
# mer_B1B4_sum <- inner_join(B1B4, sum_data, by = "ID")
# B1B4_ninfec <- mer_B1B4_sum %>% filter(PostV1BTI != "yes" & 
#                                          PostV2BTI != "yes" & 
#                                          PostV3BTI != "yes")
B1B4_ninfec <- B1B4[!B1B4$ID %in% c("FB147","FB211","FB299","FB277", "FB361",
                             "FB117" ,"FB320" , "FB342", "FB336", "FB335" ,
                             "FB374",
                             "FB198" ,"FB206","FB189", "FB295",
                             "FB169","FB349","FB369"),]
## Del non-relevant column
B1B4_clean <- B1B4_ninfec[,-c(6:23)]
## Rename
B1B4_clean$Patch <- ifelse(B1B4_clean$Patch == "B1","Day0",
                               ifelse(B1B4_clean$Patch == "B4", "Day14",
                                      B1B4_clean$Patch))
colnames(B1B4_clean)[colnames(B1B4_clean) == "SARS-CoV-2"] <- "VOC"
## Del V4 drop-out row
ov_B1B4 <- B1B4_clean %>% filter(ID != "FB030" &
                                          ID != "FB188"&
                                          ID != "FB291")
## GMT
ov_B1B4_0814_log <- ov_B1B4_0814
ov_B1B4_0814_log$Levels <- log(ov_B1B4_0814_log$Levels)
GMT_ov_B1B4<-summarySE(ov_B1B4_0814_log, measurevar="Levels",
                    groupvars=c("Patch","Group","VOC"),
                    na.rm = TRUE)
GMT_ov_B1B4$"GMT95%CI.n" <- paste0(round(exp(GMT_ov_B1B4$Levels),2)," (",paste(round(exp(GMT_ov_B1B4$Levels-GMT_ov_B1B4$ci),2),"-",paste(round(exp(GMT_ov_B1B4$Levels+GMT_ov_B1B4$ci),2)),";","n=",GMT_ov_B1B4$N),")") 
GMT_ov_B1B4$GMT <- exp(GMT_ov_B1B4$Levels)
GMT_ov_B1B4$lowerCI <- round(exp(GMT_ov_B1B4$Levels-GMT_ov_B1B4$ci),2)
GMT_ov_B1B4$upperCI <- round(exp(GMT_ov_B1B4$Levels+GMT_ov_B1B4$ci),2)

# Levels
GMT_ov_B1B4$Patch <- factor(GMT_ov_B1B4$Patch,levels = c("Day0","Day14"))
GMT_ov_B1B4$Group <- factor(GMT_ov_B1B4$Group,levels = c("RQ3027",
                                                   "RQ3025",
                                                   "RQ3013"))
ov_B1B4$Group <- factor(ov_B1B4$Group,levels = c("RQ3027",
                                                   "RQ3025",
                                                   "RQ3013"))

## Select each variant
WT_B1B4 <- subset(ov_B1B4, VOC=="Prototype")
GMT_WT_B1B4 <- subset(GMT_ov_B1B4,VOC=="Prototype")

BA.45_B1B4 <- subset(ov_B1B4, VOC=="BA.4/5")
GMT_BA.45_B1B4 <- subset(GMT_ov_B1B4,VOC=="BA.4/5")

BF.7_B1B4 <- subset(ov_B1B4, VOC=="BF.7")
GMT_BF.7_B1B4 <- subset(GMT_ov_B1B4,VOC=="BF.7")

XBB.1.5_B1B4 <- subset(ov_B1B4, VOC=="XBB.1.5")
GMT_XBB.1.5_B1B4 <- subset(GMT_ov_B1B4,VOC=="XBB.1.5")

XBB.1.16_B1B4 <- subset(ov_B1B4, VOC=="XBB.1.16")
GMT_XBB.1.16_B1B4 <- subset(GMT_ov_B1B4,VOC=="XBB.1.16")

XBB.1.9.1_B1B4 <- subset(ov_B1B4, VOC=="XBB.1.9.1")
GMT_XBB.1.9.1_B1B4 <- subset(GMT_ov_B1B4,VOC=="XBB.1.9.1")


# ggplot
## WT
p_WT_B1B4 <- ggplot(GMT_WT_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = WT_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
## BA.45
p_BA.45_B1B4 <- ggplot(GMT_BA.45_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = BA.45_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
## BF.7
p_BF.7_B1B4 <- ggplot(GMT_BF.7_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = BF.7_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
## XBB.1.5
p_XBB.1.5_B1B4 <- ggplot(GMT_XBB.1.5_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = XBB.1.5_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
## XBB.1.16
p_XBB.1.16_B1B4 <- ggplot(GMT_XBB.1.16_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = XBB.1.16_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")
## XBB.1.9.1
p_XBB.1.9.1_B1B4 <- ggplot(GMT_XBB.1.9.1_B1B4, aes(x=Patch,y=GMT,color=Group)) + geom_bar(stat="identity",
           position = position_dodge(),
           width=0.9,
           linewidth=0.5,
           fill="white") + facet_grid(~Group) + 
  geom_errorbar(aes(ymin=lowerCI,
                    ymax=upperCI),
                width=.2,
                size=0.5,
                position = position_dodge(0.9))+ 
  geom_beeswarm(data = XBB.1.9.1_B1B4,
                dodge.width = 0.9,
                aes(y = Levels,
                    x= Patch,
                    color=Group),
                cex = 2,
                size = 1.6,
                alpha=.4,
                shape=16,
                show.legend = FALSE)+ 
  theme_classic() +
  scale_color_manual(values = c("RQ3027" = "#740D91",
                                "RQ3025" = "#02915A",
                                "RQ3013" = "#09357A")) + 
  theme(legend.position = 'top',
        legend.text = element_text(size = 12)) +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.line.y = element_line(color = 'black'),
        axis.title.y = element_text(size = 12, color="black")) +
  theme(strip.text.x = element_text(size = 12),
        strip.switch.pad.grid = unit(10,"lines"),
        strip.background.x = element_rect(color = "white"),
        panel.spacing.x = unit(0.15,"cm"),
        panel.grid = element_blank(),
        panel.background = element_blank()) +
  theme(axis.text.x = element_text(margin = margin(t=5,
                                                   r=0,
                                                   b=0,
                                                   l=0))) +
  scale_y_continuous(trans = log10_trans(),
                     breaks =trans_breaks("log10", function(x) 10^x),
                     labels =trans_format("log10", math_format(10^.x)),
                     expand = c(0,0),
                     limits = c(10^0,10^6)) + 
  labs(title = "",x = "",y = "Pseudovirus Neutralizing Titers \nGMT (95%CI)")

## Merge plot
p_6v_B1B4 <- (p_WT_B1B4 | p_BA.45_B1B4 | p_BF.7_B1B4) / 
  (p_XBB.1.5_B1B4 | p_XBB.1.16_B1B4 | p_XBB.1.9.1_B1B4)

```